## Extracted Content from `OWL 18 Services`


This tutorial explores "services" in OWL components for Odoo 17, which are JavaScript objects that provide global functionalities, often interacting with the server.

### Understanding Services in OWL

In OWL, services are pieces of code that offer specific functionalities, such as handling notifications, maintaining a global state, or interacting with the Odoo backend. Unlike components, services are not tied to the DOM or a specific UI.

Key characteristics of OWL services:
* **Purpose:** Services provide functionalities that are needed across different parts of the application, like managing notifications or holding shared data.
* **Lifespan:** They remain active as long as the web client is alive in the user's browser.
* **Registry and Category:** Services are typically registered in a specific category within Odoo's web client registry, usually named `services`.
* **`start()` Function:** Instead of a `setup()` function like components, services have a `start()` function that runs when the service is initialized. This is a common point of confusion for developers transitioning from components.
* **Dependencies:** Services can declare dependencies on other services. These dependencies are injected into the `start()` function. The first argument to the `start()` function is the environment, followed by an object containing the requested services.
* **`useService` Hook:** Components can access services using the `useService` hook. You simply pass the name of the service you want to use to this hook. The `useService` hook returns whatever is returned by the service's `start()` function.
* **Not Directly Reactive with `useState`:** When building a service, if you want to manage a reactive state within it, you should use the `Reactive` primitive directly instead of `useState`. This is because `useState` is designed for components and wraps the `Reactive` primitive with the component's rendering function, which services do not have.

### Implementing and Using Services in Odoo 17

This section walks you through creating a simple service, integrating it into Odoo, and then consuming it from an OWL component.

Assume you have `ExampleComponent` (parent) and `ChildComponent` (child) set up from previous tutorials.

#### Goal 1: Create a simple service and observe its execution

1.  **Create a New Directory for Services:**
    * Inside your module's `static/src/` directory, create a new directory named `lib` (or `services`) to store your services.

2.  **Create Your Service File (`my_service.js`):**
    * Inside the `lib` directory, create a new JavaScript file, e.g., `my_service.js`.
    * Define a JavaScript object that will serve as your service. This object must contain a `start()` function.
    * Register your service in the Odoo registry under the `services` category. The service name should typically be kebab-cased (e.g., `my-service`).

    ```javascript
    // my_module/static/src/lib/my_service.js
    import { registry } from "@web/core/registry"; // Import registry

    const myService = {
        start() {
            // This function runs when the service starts
            console.log("My service has started!");
            // Set an interval to show an alert every 5 seconds
            setInterval(() => {
                alert("Hello from my service!");
            }, 5000);

            // You can return anything here; it will be accessible via useService
            return "hello"; // Returning a simple string for demonstration
        },
    };

    // Register the service
    registry.category("services").add("my-service", myService);
    ```

3.  **Include the Service in Your Module's Assets (`__manifest__.py`):**
    * Open your module's `__manifest__.py` file.
    * In the `assets` dictionary, ensure your service file is included in the relevant bundle (e.g., `web.assets_backend`). You can use a wildcard for simplicity if all your services are in the `lib` directory.

    ```python
    # my_module/__manifest__.py
    {
        'name': 'My Module',
        # ... other manifest fields
        'assets': {
            'web.assets_backend': [
                'my_module/static/src/components/**/*', # Includes existing components
                'my_module/static/src/lib/**/*',       # Includes all files in the lib directory
            ],
        },
    }
    ```

4.  **Restart Odoo Server and Test:**
    * Restart your Odoo instance.
    * Go to any Odoo backend page (e.g., the dashboard or sales app).
    * After the page loads, you should start seeing "Hello from my service!" alerts pop up every 5 seconds. This confirms that your service is running because the `web.assets_backend` bundle has been loaded.
    * To verify when the service *doesn't* load, try logging out or clearing site data, then visit the login page. You shouldn't see the alerts there, as `web.assets_backend` isn't loaded yet.

#### Goal 2: Use an existing Odoo service (`notification` service) within your custom service

1.  **Modify `my_service.js` to Use `notification` Service:**
    * Import `NotificationService` (or just `notification`) and `env` (environment) from `@web/core/network/rpc`.
    * Declare `notification` as a dependency in your `myService` object.
    * In the `start()` function, destructure `notification` from the `services` object passed as the second argument.
    * Replace `alert()` with `notification.add()` to show an Odoo-style notification.

    ```javascript
    // my_module/static/src/lib/my_service.js
    import { registry } from "@web/core/registry";
    import { NotificationService } from "@web/core/notifications/notification_service"; // Correct import for notification service

    const myService = {
        dependencies: ["notification"], // Declare notification as a dependency
        start(env, { notification }) { // Destructure notification service
            console.log("My service has started!");
            setInterval(() => {
                notification.add("Hello from my Odoo service!", {
                    type: "info", // You can specify type: success, warning, danger, info
                    sticky: false, // Notification disappears after a few seconds
                });
            }, 5000);

            return "hello";
        },
    };

    registry.category("services").add("my-service", myService);
    ```

2.  **Restart Odoo Server and Test:**
    * Restart your Odoo instance.
    * Navigate to an Odoo backend page.
    * Instead of disruptive alerts, you should now see discreet Odoo-style notifications appearing every 5 seconds.

#### Goal 3: Consume your custom service from an OWL component

1.  **Modify `ExampleComponent` (Parent) (`example.js`):**
    * Import `useService` from `@web/core/utils/hooks`.
    * In the `setup()` method, use `useService` to get an instance of your `my-service`. Assign it to `this.myService`.
    * You can then add a debugger to inspect `this.myService` and verify it contains the `hello` string returned by your service's `start()` function.

    ```javascript
    // my_module/static/src/components/example/example.js
    import { Component, useState, useSubEnv } from "@odoo/owl";
    import { ChildComponent } from "../child/child";
    import { useService } from "@web/core/utils/hooks"; // Import useService

    export class ExampleComponent extends Component {
        static template = "my_module.example_owl_template";
        static components = { ChildComponent };

        setup() {
            this.state = useState({ counter: 0 });
            useSubEnv({ data: "info" });

            this.myService = useService("my-service"); // Consume your custom service
            debugger; // Add debugger here to inspect this.myService
            // ... existing setup logic
        }

        increment() {
            this.state.counter++;
        }
    }
    ```

2.  **Restart Odoo Server and Test:**
    * Restart your Odoo instance.
    * Navigate to the Odoo backend page where your `ExampleComponent` is rendered.
    * The debugger should trigger. In the console, inspect `this.myService`. You should see the value `hello`. This confirms that your component successfully accessed the instance returned by your service.

#### Exercise: Convert the Counter into a Service

The final exercise is to refactor your existing counter logic and state into a service and consume it from your `ExampleComponent`.

1.  **Create a New Service for the Counter:**
    * Create a new file, e.g., `counter_service.js`, in `my_module/static/src/lib/`.
    * Import `Reactive` from `@odoo/owl` (since services don't have a rendering context, use `Reactive` directly for state management).
    * Define your service with a `start()` function.
    * Inside `start()`, create a `Reactive` object for your counter state and an `increment` method that modifies this reactive state.
    * Return an object from `start()` that exposes the reactive state and the `increment` method.
    * Register this service in the registry.

    ```javascript
    // my_module/static/src/lib/counter_service.js
    import { registry } from "@web/core/registry";
    import { Reactive } from "@odoo/owl"; // Import Reactive

    const counterService = {
        start() {
            const state = Reactive.create({ value: 0 }); // Use Reactive directly
            const increment = () => {
                state.value++;
            };
            return { state, increment }; // Expose state and increment method
        },
    };

    registry.category("services").add("counter-service", counterService);
    ```

2.  **Update `__manifest__.py`:**
    * Ensure `my_module/static/src/lib/counter_service.js` is included in `web.assets_backend`.

3.  **Modify `ExampleComponent` (`example.js`):**
    * Import `useService`.
    * In `setup()`, consume `counter-service` using `useService`.
    * Remove the `useState` definition for the counter in `ExampleComponent` as the state will now come from the service.
    * Update your `increment` method to call the `increment` method from the consumed service.
    * Pass the service's reactive state to the `ChildComponent`.

    ```javascript
    // my_module/static/src/components/example/example.js
    import { Component, useSubEnv } from "@odoo/owl"; // Remove useState
    import { ChildComponent } from "../child/child";
    import { useService } from "@web/core/utils/hooks";

    export class ExampleComponent extends Component {
        static template = "my_module.example_owl_template";
        static components = { ChildComponent };

        setup() {
            this.counterService = useService("counter-service"); // Consume the counter service
            useSubEnv({ data: "info" });
        }

        increment() {
            this.counterService.increment(); // Call increment from the service
        }
    }
    ```

4.  **Modify `ExampleComponent`'s Template (`example.xml`):**
    * Pass the service's state to the `ChildComponent` via props.

    ```xml
    <templates>
        <t t-name="my_module.example_owl_template">
            <div>
                <p>Hello Owl</p>
                <button t-on-click="increment" class="btn btn-primary">Click me</button>
                <hr/>
                <ChildComponent counter="counterService.state.value"/>
            </div>
        </t>
    </templates>
    ```

5.  **Restart Odoo Server and Test:**
    * Restart Odoo.
    * Update your module.
    * Navigate to your component's view. Clicking the button should still increment the counter displayed in the child component, but now the state and logic are centralized in a dedicated service.

This exercise demonstrates how services can be used to encapsulate global state and logic, making your component code cleaner and more maintainable.